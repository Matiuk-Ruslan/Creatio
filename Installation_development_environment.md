# Development environment

## **Установка**

---

1. [Проверить обязательные компоненты](https://academy.terrasoft.ru/docs/user/ustanovka_i_administrirovanie/razvertyvanie_onsite/server_prilozhenij_net_framework_na_windows/proverit_obyazatelnye_komponenty_windows)

2. Скачать [Creatio 7.15.4.3055](https://drive.google.com/drive/folders/1-4EqnTnuXP-oLxOAioTmSEru_IDOP2O_?usp=sharing) из Google Drive

3. Распаковать архив в директорию: `С:\inetpub\wwwroot\[Создайте папку для приложения]`

4. Развернуть базу данных: `С:\inetpub\wwwroot\[Папка приложения]\db\[Название базы данных].bak`

5. Создать пользователя для базы данных на уровне локального сервера
    * **Server Roles**: public, sysadmin
    * **User Mapping**: public, db_owner

6. Настроить `Internet Information Services (IIS)`:
    * Добавляем сайт, указывая физическое размещение: `С:\inetpub\wwwroot\[Папка приложения]`
    * Добавляем приложение, указывая физическое размещение приложения: `С:\inetpub\wwwroot\[Папка приложения]\Terrasoft.WebApp`
      * Стандартный псевдоним приложения `0`

7. Настраиваем `С:\inetpub\wwwroot\[Папка приложения]\ConnectionString.config`. **Пример:**

    ```XML
    <?xml version="1.0" encoding="utf-8"?>
    <connectionStrings>
      <add name="redis" connectionString="host=ИМЯ_ХОСТА;db=10;port=6379;maxReadPoolSize=10;maxWritePoolSize=500" />
      <add name="redisSentinel" connectionString="sentinelHosts=localhost:26380,localhost:26381,localhost:26382;masterName=mymaster;scanForOtherSentinels=false;db=1;maxReadPoolSize=10;maxWritePoolSize=500" />
      <add name="defPackagesWorkingCopyPath" connectionString="%TEMP%\%APPLICATION%\%APPPOOLIDENTITY%\%WORKSPACE%\TerrasoftPackages" />
      <add name="tempDirectoryPath" connectionString="%TEMP%\%APPLICATION%\%APPPOOLIDENTITY%\%WORKSPACE%\" />
      <add name="sourceControlAuthPath" connectionString="%TEMP%\%APPLICATION%\%APPPOOLIDENTITY%\%WORKSPACE%\Svn" />
      <add name="elasticsearchCredentials" connectionString="User=gs-es; Password=DEQpJMfKqUVTWg9wYVgi;" />
      <add name="influx" connectionString="url=http://10.0.7.161:30359; user=; password=; batchIntervalMs=5000" />
      <add name="db" connectionString="Data Source=ИМЯ_КОМПЬЮТЕРА;Initial Catalog=ИМЯ_БАЗЫ_ДАННЫХ;Persist Security Info=True;User ID=ИМЯ_ПОЛЬЗОВАТЕЛЯ_БАЗЫ_ДАННЫХ; Password=ПАРОЛЬ_ПОЛЬЗОВАТЕЛЯ_БАЗЫ_ДАННЫХ; MultipleActiveResultSets=True;Pooling=true;Max Pool Size=100; Async = true"/>
    </connectionStrings>
    ```

## **Настройка**

1. Настроить Creatio для работы в файловой системе:
    * В файле `С:\inetpub\wwwroot\[Папка приложения]\Web.config`, установите значение `true` для атрибута `enabled` элемента `fileDesignMode`

        ```XML
        <fileDesignMode enable="true" />
        ```

    * На текущий момент режим РФС не совместим с получением клиентского контента из предварительно сгенерированных файлов. Для корректной работы с РФС необходимо отключить получение статического клиентского контента из файловой системы. В файле `С:\inetpub\wwwroot\[Папка приложения]\Web.config`, установите значение `false` для флага `UseStaticFileContent`

        ```XML
        <add key="UseStaticFileContent" value="false" />
        ```

    * Предоставить полный доступ к `С:\inetpub\wwwroot\` пользователю операционной системы `IIS_IUSRS`
    * Выгрузить пакеты в файловую систему
    * Скомпилировать приложение на панели инструментов Creatio, раздела [Конфигурация]
    * Выгрузить пакеты в файловую систему
    * Обновить пакеты из файловой системы
    * Все выгруженные файли можно найти в директории: `С:\inetpub\wwwroot\[Папка приложения]\Terrasoft.WebApp\Terrasoft.Configuration\Autogenerated\Src\`
    * Все выгруженные пакеты можно найти в директории: `С:\inetpub\wwwroot\[Папка приложения]\Terrasoft.WebApp\Terrasoft.Configuration\Pkg\`

2. Запустить приложения через `Диспечер служб IIS`
    * Зайти в приложение под **Login:** Supervisor / **Password:** Supervisor
    * Перейти по адресу: `[Адрес сайта]/0/Nui/ViewModule.aspx#SetupTelephonyParametersPageModule`
      * Поставить в чекбоксе `true` на настройке `[Disable Call Сentre integration]`
    * Перейти по адресу: `[Адрес сайта]/0/Nui/ViewModule.aspx#UserProfile`
      * Выбрать значение поля `[Date and time format]`
      * Выбрать значение поля `[Time zone]`
      * Выбрать значение поля `[Language]`

3. Сохраняем и перезаходим в систему Creatio

4. Перейти по адресу: `[Адрес сайта]/0/Nui/ViewModule.aspx#SectionModuleV2/SysSettingsSection`
    * Найти настройку `DefaultTimeZone`:
      * Выбрать значение поля `Default value`
      * Значение поля `Save value for current user` = `false`

5. Сохраняем и перезаходим в систему Creatio

## [Конфигурируем Logger](https://github.com/Academy-Creatio/TrainingProgramm/wiki/Custom-Logging-with-NLog)

1. Найти `С:\inetpub\wwwroot\[Папка приложения]\Terrasoft.WebApp\nlog.target.config` и добавить следующее:

    ```XML
    <target name="ИМЯ_ФАЙЛА_ЛОГИРОВАНИЯ_Appender" xsi:type="File" 
    layout="${Date} [${ThreadIdOrName}] ${uppercase:${level}} ${UserName} ${MethodName} - ${Message}" 
    fileName="${LogDir}/${LogDay}/ИМЯ_ФАЙЛА_ЛОГИРОВАНИЯ.log" />
    ```

2. Найти `С:\inetpub\wwwroot\[Папка приложения]\Terrasoft.WebApp\nlog.config` и добавить следующее:

    ```XML
    <logger name="ИМЯ_ФАЙЛА_ЛОГИРОВАНИЯ_Logger" writeTo="ИМЯ_ФАЙЛА_ЛОГИРОВАНИЯ_Appender" minlevel="Info" final="true" />
    ```

3. Пример использования в коде:

    ``` CSharp
    using global::Common.Logging;
    namespace SomeNameSpace
    {
      class MyCLass
      {
        private static readonly ILog _log = LogManager.GetLogger("ИМЯ_ФАЙЛА_ЛОГИРОВАНИЯ_Logger");
      }
    }
    ```

4. [Перезапустить Creatio с помощью `Clio`](https://github.com/Matiuk-Ruslan/Knowledge_Base_Creatio/blob/main/Clio.md)

## **Создаем собственный пакет для разработки**

1. Заходим в директорию с помощью терминала:
    `С:\inetpub\wwwroot\[Папка приложения]\Terrasoft.WebApp\Terrasoft.Configuration\Pkg\`

2. Создаем новый пакет Creatio:

    ```BASH
    clio init NAME_PACKAGE
    ```

3. Заходим в директорию собственного пакета и открываем проект NAME_PACKAGE.sln в VisualStudio.

4. Восстанавливаем NuGet пакет `CreatioSDK`, той версии что у вас приложение Creatio.

5. Следующие материалы изложены в папке `Development`

## **Примечания и рекомендации**

* `Shortcut` [Переход в раздел Конфигурация]:`[Адрес сайта]/0/dev`

* Существуе 16 баз данных `Redis`, от 0 до 15.
Для приложения должна быть уникальная база данных `Redis`, то есть только наше приложение должно использовать эту базу данных.

* Пример названия сущностей при создании среды разработки:
  * `Acronyms:`
    * DE - Development Environment
    * DB - Database
    * SFN - Site folder name
    * SN - Site name
    * _T - Testing
  * `Site folder name:`
    * Name:           CreatioSFN_002_Sandbox
    * Folder path:    `C:\inetpub\wwwroot\`
  * `Database connection:`
    * Catalog: CreatioDB_002_Sandbox
    * User ID: AdminCreatio_T
    * Password: root_12345
  * `IIS:`
    * Physical path:  `C:\inetpub\wwwroot\CreatioSFN_002_Sandbox`
    * Site name:      CreatioSN_002_Sandbox
    * Port:           1235

* В начале реализации каждой задачи:
  * Полностью копируем папку приложения
  * Полностью делаем бекап базы данных приложения

P.S. Для включения режима отладки на стороне клиента измените значение системной настройки [`IsDebug`](https://academy.creatio.com/documents/technic-sdk/7-15/isdebug-mode) --> [Default value] = `true`

## Откат системы после неудачной поставки

**Инструкция:**

1. Подмена базы данных
2. Полностью очистить папку по пути - `.\Terrasoft.WebApp\conf\content`
3. Зайти в приложение, может выдать ошибку при входе, чтобы её обойти и зайти в конфигурацию, необходимо поменять url (адресную строку сайта). Например - выдает `https://eva.creatio.com/0/Nui/ViewModule.aspx`, меняем на `https://eva.creatio.com/0/dev`
4. Запускаем полную компиляцию системы.
